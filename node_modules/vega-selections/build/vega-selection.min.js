!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-expression")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-expression"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).vega={},e.vega,e.vega)}(this,(function(e,t,n){"use strict";function r(e,t){return null==e||null==t?NaN:e<t?-1:e>t?1:e>=t?0:NaN}function i(e,t){return null==e||null==t?NaN:t<e?-1:t>e?1:t>=e?0:NaN}function u(){return 0}class s extends Set{constructor(e,t=o){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:t}}),null!=e)for(const t of e)this.add(t)}has(e){return super.has(function({_intern:e,_key:t},n){const r=t(n);return e.has(r)?e.get(r):n}(this,e))}add(e){return super.add(function({_intern:e,_key:t},n){const r=t(n);return e.has(r)?e.get(r):(e.set(r,n),n)}(this,e))}delete(e){return super.delete(function({_intern:e,_key:t},n){const r=t(n);e.has(r)&&(n=e.get(r),e.delete(r));return n}(this,e))}}function o(e){return null!==e&&"object"==typeof e?e.valueOf():e}function f(e){return e instanceof s?e:new s(e)}const l=Symbol("vega_selection_getter");function a(e){return e.getter&&e.getter[l]||(e.getter=t.field(e.field),e.getter[l]=!0),e.getter}const c="intersect",d="union",g="or",p="and",h="_vgsid_",v=t.field(h),y="index:unit";function m(e,n){for(var r,i,u=n.fields,s=n.values,o=u.length,f=0;f<o;++f)if(r=a(i=u[f])(e),t.isDate(r)&&(r=t.toNumber(r)),t.isDate(s[f])&&(s[f]=t.toNumber(s[f])),t.isArray(s[f])&&t.isDate(s[f][0])&&(s[f]=s[f].map(t.toNumber)),"E"===i.type){if(t.isArray(s[f])?!s[f].includes(r):r!==s[f])return!1}else if("R"===i.type){if(!t.inrange(r,s[f]))return!1}else if("R-RE"===i.type){if(!t.inrange(r,s[f],!0,!1))return!1}else if("R-E"===i.type){if(!t.inrange(r,s[f],!1,!1))return!1}else if("R-LE"===i.type){if(!t.inrange(r,s[f],!1,!0))return!1}else if("E-LT"===i.type){if(r>=s[f])return!1}else if("E-LTE"===i.type){if(r>s[f])return!1}else if("E-GT"===i.type){if(r<=s[f])return!1}else if("E-GTE"===i.type){if(r<s[f])return!1}else if("E-VALID"===i.type){if(null===r||isNaN(r))return!1}else if("E-ONE"===i.type&&-1===s[f].indexOf(r))return!1;return!0}const b=function(e){let t,n,s;function o(e,r,i=0,u=e.length){if(i<u){if(0!==t(r,r))return u;do{const t=i+u>>>1;n(e[t],r)<0?i=t+1:u=t}while(i<u)}return i}return 2!==e.length?(t=r,n=(t,n)=>r(e(t),n),s=(t,n)=>e(t)-n):(t=e===r||e===i?e:u,n=e,s=e),{left:o,center:function(e,t,n=0,r=e.length){const i=o(e,t,n,r-1);return i>n&&s(e[i-1],t)>-s(e[i],t)?i-1:i},right:function(e,r,i=0,u=e.length){if(i<u){if(0!==t(r,r))return u;do{const t=i+u>>>1;n(e[t],r)<=0?i=t+1:u=t}while(i<u)}return i}}}(v),_=b.left,N=b.right;var E={[`${h}_union`]:function(...e){const t=new s;for(const n of e)for(const e of n)t.add(e);return t},[`${h}_intersect`]:function(e,...t){e=new s(e),t=t.map(f);e:for(const n of e)for(const r of t)if(!r.has(n)){e.delete(n);continue e}return e},E_union:function(e,t){if(!e.length)return t;for(var n=0,r=t.length;n<r;++n)e.includes(t[n])||e.push(t[n]);return e},E_intersect:function(e,t){return e.length?e.filter((e=>t.includes(e))):t},R_union:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?(e[0]>r&&(e[0]=r),e[1]<i&&(e[1]=i),e):[r,i]},R_intersect:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?i<e[0]||e[1]<r?[]:(e[0]<r&&(e[0]=r),e[1]>i&&(e[1]=i),e):[r,i]}};e.selectionIdTest=function(e,t,n){const r=this.context.data[e],i=r?r.values.value:[],u=r?r[y]&&r[y].value:void 0,s=n===c,o=v(t),f=_(i,o);if(f===i.length)return!1;if(v(i[f])!==o)return!1;if(u&&s){if(1===u.size)return!0;if(N(i,o)-f<u.size)return!1}return!0},e.selectionResolve=function(e,n,r,i){for(var u,s,o,f,l,a,c,y,m,b,_,N,x=this.context.data[e],O=x?x.values.value:[],T={},R={},j={},k=O.length,w=0;w<k;++w)if(f=(u=O[w]).unit,s=u.fields,o=u.values,s&&o){for(_=0,N=s.length;_<N;++_)l=s[_],y=(c=T[l.field]||(T[l.field]={}))[f]||(c[f]=[]),j[l.field]=m=l.type.charAt(0),b=E[`${m}_union`],c[f]=b(y,t.array(o[_]));r&&(y=R[f]||(R[f]=[])).push(t.array(o).reduce(((e,t,n)=>(e[s[n].field]=t,e)),{}))}else l=h,a=v(u),(y=(c=T[l]||(T[l]={}))[f]||(c[f]=[])).push(a),r&&(y=R[f]||(R[f]=[])).push({[h]:a});if(n=n||d,T[h]?T[h]=E[`${h}_${n}`](...Object.values(T[h])):Object.keys(T).forEach((e=>{T[e]=Object.keys(T[e]).map((t=>T[e][t])).reduce(((t,r)=>void 0===t?r:E[`${j[e]}_${n}`](t,r)))})),O=Object.keys(R),r&&O.length){T[i?"vlPoint":"vlMulti"]=n===d?{[g]:O.reduce(((e,t)=>(e.push(...R[t]),e)),[])}:{[p]:O.map((e=>({[g]:R[e]})))}}return T},e.selectionTest=function(e,t,n){for(var r,i,u,s,o,f=this.context.data[e],l=f?f.values.value:[],a=f?f[y]&&f[y].value:void 0,d=n===c,g=l.length,p=0;p<g;++p)if(r=l[p],a&&d){if(-1===(u=(i=i||{})[s=r.unit]||0))continue;if(o=m(t,r),i[s]=o?-1:++u,o&&1===a.size)return!0;if(!o&&u===a.get(s).count)return!1}else if(d^(o=m(t,r)))return o;return g&&d},e.selectionTuples=function(e,n){return t.isArray(e)||t.error("First argument to selectionTuples must be an array."),t.isObject(n)||t.error("Second argument to selectionTuples must be an object."),e.map((e=>t.extend(n.fields?{values:n.fields.map((t=>a(t)(e.datum)))}:{[h]:v(e.datum)},n)))},e.selectionVisitor=function(e,r,i,u){r[0].type!==n.Literal&&t.error("First argument to selection functions must be a string literal.");const s=r[0].value,o="unit",f="@"+o,l=":"+s;(r.length>=2&&t.peek(r).value)!==c||t.hasOwnProperty(u,f)||(u[f]=i.getData(s).indataRef(i,o)),t.hasOwnProperty(u,l)||(u[l]=i.getData(s).tuplesRef())}}));
//# sourceMappingURL=vega-selection.min.js.map
